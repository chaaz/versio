---
# DO NOT EDIT
# Created from template "release.yml".
name: release
"on":
  - workflow_dispatch
env:
  RUSTFLAGS: "-D warnings"
  GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
  GITHUB_USER: "${{ github.actor }}"
jobs:
  project-matrixes:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    outputs:
      cargo-matrix: "${{ steps.find-cargo-matrix.outputs.matrix }}"
      all-matrix: "${{ steps.find-all-matrix.outputs.matrix }}"
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Get versio
        uses: chaaz/versio-actions/install@v1.1
      - name: Find cargo matrix
        id: find-cargo-matrix
        run: "echo \"::set-output name=matrix::{\\\"include\\\":$(versio -l none info -l cargo -R -N)}\""
      - name: Find all matrix
        id: find-all-matrix
        run: "echo \"::set-output name=matrix::{\\\"include\\\":$(versio -l none info -a -R -N)}\""
  versio-checks:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Get versio
        uses: chaaz/versio-actions/install@v1.1
      - name: Fetch history
        run: git fetch --unshallow
      - name: Check projects
        run: versio check
      - name: Output plan
        run: versio plan
  cargo-checks:
    needs: project-matrixes
    runs-on: ubuntu-latest
    strategy:
      matrix: "${{ fromJson(needs.project-matrixes.outputs.cargo-matrix) }}"
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    defaults:
      run:
        working-directory: "${{ matrix.root }}"
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libgpg-error-dev libgpgme-dev
      - name: Get cargo stable
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: clippy
      - name: Get cargo nightly
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          components: rustfmt
      - name: Find paths
        id: cargo-find-paths
        run: "echo ::set-output name=cargo-lock-glob::\"${{ matrix.root }}\"/**/Cargo.lock"
      - name: Cache cargo and target
        uses: actions/cache@v1
        with:
          path: "~/.cargo/registry\n~/.cargo/git\n${{ matrix.root }}/target\n"
          key: "${{ runner.os }}-cargo-${{ hashFiles(steps.cargo-find-paths.outputs.cargo-lock-glob) }}"
      - name: Check format
        run: cargo +nightly fmt -- --check
  versio-release:
    needs:
      - cargo-checks
      - versio-checks
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Get versio
        uses: chaaz/versio-actions/install@v1.1
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libgpg-error-dev libgpgme-dev
      - name: Get cargo stable
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Cache cargo
        uses: actions/cache@v1
        with:
          path: "~/.cargo/registry\n~/.cargo/git\n"
          key: "${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}"
      - name: Fetch history
        run: git fetch --unshallow
      - name: Generate release
        run: versio release
  cratesio-publish:
    needs:
      - project-matrixes
      - versio-release
    runs-on: ubuntu-latest
    strategy:
      matrix: "${{fromJson(needs.project-matrixes.outputs.cargo-matrix)}}"
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    defaults:
      run:
        working-directory: "${{ matrix.root }}"
    steps:
      - name: Checkout release
        uses: actions/checkout@v2
        with:
          ref: main
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libgpg-error-dev libgpgme-dev
      - name: Get cargo stable
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: clippy
      - name: Get cargo nightly
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          components: rustfmt
      - name: Find paths
        id: cargo-find-paths
        run: "echo ::set-output name=cargo-lock-glob::\"${{ matrix.root }}\"/**/Cargo.lock"
      - name: Cache cargo and target
        uses: actions/cache@v1
        with:
          path: "~/.cargo/registry\n~/.cargo/git\n${{ matrix.root }}/target\n"
          key: "${{ runner.os }}-cargo-${{ hashFiles(steps.cargo-find-paths.outputs.cargo-lock-glob) }}"
      - name: Login to crates.io
        run: "cargo login ${CRATES_IO_TOKEN}"
        env:
          CRATES_IO_TOKEN: "${{ secrets.CRATES_IO_TOKEN }}"
      - name: Publish to crates.io
        run: cargo publish
  github-publish:
    needs: versio-release
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    outputs:
      upload_url: "${{ steps.publish-to-github.outputs.upload_url }}"
    steps:
      - name: Checkout release
        uses: actions/checkout@v2
        with:
          ref: main
      - name: Get versio
        uses: chaaz/versio-actions/install@v1.1
      - name: Find version
        id: find-version
        run: "echo ::set-output name=version::$(versio -l none info -i 0 -F | jq -r '.[0].full_version')"
      - name: Publish to GitHub
        id: publish-to-github
        uses: actions/create-release@v1
        with:
          tag_name: "${{ steps.find-version.outputs.version }}"
          release_name: "(TODO) RELEASE FOR ${{ steps.find-version.outputs.version }}"
          body: "(TODO) SUMMARY\n- (TODO) FEATURE1\n\nNew to Versio? The [repository](https://github.com/chaaz/versio) is the best place to learn about Versio and what it can do. If you want to report a bug or request a feature, you can do so at our [Issues](https://github.com/chaaz/versio/issues) link, but we ask you first read the [Troubleshooting](https://github.com/chaaz/versio/blob/main/docs/troubleshooting.md) page learn about problems and their solutions.\n\nTo install, follow the instructions for your platform; some files might be zipped for improved download speed. For example, on MacOS you can do something like this (assuming `~/bin` exists and is in your PATH):\n\n```sh\ncurl -L https://github.com/chaaz/versio/releases/download/${{ steps.find-version.outputs.version }}/versio__x86_64-apple-darwin -o ~/bin/versio\nchmod +x ~/bin/versio\n```\n\n**MacOS:** download `versio__x86_64-apple-darwin`, copy to `versio` in your PATH.\n**GNU Linux 64:** download `versio__x86_64-unknown-linux-gnu`, copy to `versio` in your PATH.\n**Windows:** download `versio__x86_64-pc-win32.exe`, copy to `versio.exe` in your %PATH.\n"
          draft: true
          prerelease: false
          commitish: main
  publish-versio:
    needs: github-publish
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            root: "."
            rustflags: "-D warnings -C link-args=-s"
            bin_name: versio
          - os: macos-latest
            target: x86_64-apple-darwin
            root: "."
            rustflags: "-D warnings"
            bin_name: versio
          - os: windows-latest
            target: x86_64-pc-win32.exe
            root: "."
            rustflags: "-D warnings"
            bin_name: versio.exe
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    runs-on: "${{ matrix.os }}"
    steps:
      - name: Checkout release
        uses: actions/checkout@v2
        with:
          ref: main
      - name: Install Ubuntu dependencies
        if: "matrix.os == 'ubuntu-latest'"
        run: sudo apt-get update && sudo apt-get install -y libgpg-error-dev libgpgme-dev
      - name: Install MacOS dependencies
        if: "matrix.os == 'macos-latest'"
        run: brew update; brew install gpgme
      - name: Try to use msys2
        if: "matrix.os == 'windows-latest'"
        run: "@(\"C:\\msys64\\usr\\bin\") + (Get-Content $env:GITHUB_PATH) | Set-Content $env:GITHUB_PATH\n"
      - name: Install Windows dependencies
        if: "matrix.os == 'windows-latest'"
        env:
          RUNNER_TEMP: "${{ runner.temp }}"
        working-directory: "${{ runner.temp }}"
        shell: bash
        run: "export PATH=\"/c/msys64/usr/bin:$PATH\"\npacman --noconfirm -S msys2-runtime-devel\ncurl https://gnupg.org/ftp/gcrypt/libgpg-error/libgpg-error-1.42.tar.bz2 -o libgpg-error-1.42.tar.bz2\ntar -jxf libgpg-error-1.42.tar.bz2\ncurl https://gnupg.org/ftp/gcrypt/libassuan/libassuan-2.5.5.tar.bz2 -o libassuan-2.5.5.tar.bz2\ntar -jxf libassuan-2.5.5.tar.bz2\ncurl https://gnupg.org/ftp/gcrypt/gpgme/gpgme-1.16.0.tar.bz2 -o gpgme-1.16.0.tar.bz2\ntar -jxf gpgme-1.16.0.tar.bz2\npushd libgpg-error-1.42\n./configure --enable-static\nmake\nmake install\npopd\npushd libassuan-2.5.5\n./configure --enable-static\nmake\nmake install\npopd\npushd gpgme-1.16.0\n./configure --enable-static\nmake\nmake install\npopd\n"
      - name: Get cargo stable
        if: "matrix.os != 'windows-latest'"
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: clippy
      - name: Get cargo nightly
        if: "matrix.os != 'windows-latest'"
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          components: rustfmt
      - name: Get Windows cargo stable
        if: "matrix.os == 'windows-latest'"
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable-x86_64-pc-windows-msvc
          target: x86_64-pc-windows-gnu
          components: clippy
          default: true
      - name: Get Windows cargo nightly
        if: "matrix.os == 'windows-latest'"
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-x86_64-pc-windows-msvc
          target: x86_64-pc-windows-gnu
          components: rustfmt
      - name: Update Windows target configuration
        if: "matrix.os == 'windows-latest'"
        run: rustup set default-host x86_64-pc-windows-gnu
      - name: Find paths
        id: cargo-find-paths
        run: "echo ::set-output name=cargo-lock-glob::\"${{ matrix.root }}\"/**/Cargo.lock"
      - name: Cache cargo and target
        uses: actions/cache@v1
        with:
          path: "~/.cargo/registry\n~/.cargo/git\n${{ matrix.root }}/target\n"
          key: "${{ runner.os }}-cargo-${{ hashFiles(steps.cargo-find-paths.outputs.cargo-lock-glob) }}"
      - name: Examine GnuPG include Windows
        if: "matrix.os == 'windows-latest'"
        run: "ls 'C:\\Program Files (x86)\\gnupg\\include'"
      - name: Add mingw64 to PATH
        if: "matrix.os == 'windows-latest'"
        run: "echo \"C:\\msys64\\mingw64\\bin\" >> $env:GITHUB_PATH\n"
      - name: Build Ubuntu binary
        if: "matrix.os == 'ubuntu-latest'"
        run: cargo build --release
        working-directory: "${{ matrix.root }}"
        env:
          RUSTFLAGS: "${{ matrix.rustflags }}"
          LIBGPG_ERROR_INCLUDE: /usr/include/x86_64-linux-gnu
          LIBGPG_ERROR_LIB_DIR: /usr/lib/x86_64-linux-gnu
          LIBGPG_ERROR_LIBS: static=gpg-error
          GPGME_INCLUDE: /usr/include
          GPGME_LIB_DIR: /usr/lib/x86_64-linux-gnu
          GPGME_LIBS: "static=gpgme:static=assuan"
      - name: Build MacOS binary
        if: "matrix.os == 'macos-latest'"
        run: cargo build --release
        working-directory: "${{ matrix.root }}"
        env:
          RUSTFLAGS: "${{ matrix.rustflags }}"
          LIBGPG_ERROR_INCLUDE: /usr/local/opt/libgpg-error/include
          LIBGPG_ERROR_LIB_DIR: /usr/local/opt/libgpg-error/lib
          LIBGPG_ERROR_LIBS: static=gpg-error
          GPGME_INCLUDE: "/usr/local/opt/libassuan/include:/usr/local/opt/gpgme/include"
          GPGME_LIB_DIR: "/usr/local/opt/libassuan/lib:/usr/local/opt/gpgme/lib"
          GPGME_LIBS: "static=gpgme:static=assuan"
      - name: Build Windows binary
        if: "matrix.os == 'windows-latest'"
        run: cargo build --release --target x86_64-pc-windows-gnu
        working-directory: "${{ matrix.root }}"
        env:
          RUSTFLAGS: "${{ matrix.rustflags }}"
          LIBGPG_ERROR_INCLUDE: "C:\\msys64\\mingw64\\include"
          LIBGPG_ERROR_LIB_DIR: "C:\\msys64\\mingw64\\lib"
          LIBGPG_ERROR_LIBS: static=gpg-error
          GPGME_INCLUDE: "C:\\msys64\\mingw64\\include"
          GPGME_LIB_DIR: "C:\\msys64\\mingw64\\lib"
          GPGME_LIBS: "static=gpgme:static=assuan"
          MSYS_NO_PATHCONV: 1
      - name: Upload binary
        if: "matrix.os != 'windows-latest'"
        uses: actions/upload-release-asset@v1
        with:
          upload_url: "${{ needs.github-publish.outputs.upload_url }}"
          asset_path: "target/release/${{ matrix.bin_name }}"
          asset_name: "versio__${{ matrix.target }}"
          asset_content_type: application/octet-stream
      - name: Upload Windows binary
        if: "matrix.os == 'windows-latest'"
        uses: actions/upload-release-asset@v1
        with:
          upload_url: "${{ needs.github-publish.outputs.upload_url }}"
          asset_path: "target/x86_64-pc-windows-gnu/release/${{ matrix.bin_name }}"
          asset_name: "versio__${{ matrix.target }}"
          asset_content_type: application/octet-stream